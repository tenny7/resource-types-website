'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _regenerator=require('babel-runtime/regenerator');var _regenerator2=_interopRequireDefault(_regenerator);var _asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);var _assert=require('assert');var _assert2=_interopRequireDefault(_assert);var _fs=require('fs');var _fs2=_interopRequireDefault(_fs);var _zlib=require('zlib');var _zlib2=_interopRequireDefault(_zlib);var _tmp=require('tmp');var _tmp2=_interopRequireDefault(_tmp);var _isStream=require('is-stream');var _isStream2=_interopRequireDefault(_isStream);var _through=require('through2');var _through2=_interopRequireDefault(_through);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}_tmp2.default.setGracefulCleanup();exports.default=function(){var _ref=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(rstream){var gzip,tmpFile,wstream,size,getSize,stat,deflated;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:(0,_assert2.default)(_isStream2.default.readable(rstream),'Must pass a readable stream!');gzip=_zlib2.default.createGzip();_context.next=4;return getTempFile();case 4:tmpFile=_context.sent;wstream=_fs2.default.createWriteStream(tmpFile);size=0;getSize=(0,_through2.default)(function(chunk,enc,cb){size+=Buffer.byteLength(chunk);cb(null,chunk);});rstream.pipe(getSize).pipe(gzip).pipe(wstream);_context.next=11;return new Promise(function(resolve,reject){wstream.on('error',reject);wstream.on('finish',resolve);});case 11:_context.next=13;return getFileStats(tmpFile);case 13:stat=_context.sent;_context.next=16;return getDeflatedPercent(size,stat.size);case 16:deflated=_context.sent;return _context.abrupt('return',{file:tmpFile,old_size:size,new_size:stat.size,deflated:deflated});case 18:case'end':return _context.stop();}}},_callee,this);}));return function(_x){return _ref.apply(this,arguments);};}();function getTempFile(){return new Promise(function(resolve,reject){var config={prefix:'sums_',postfix:'.gz'};_tmp2.default.file(config,function(err,file){if(err)reject(err);else resolve(file);});});}function getFileStats(file){return new Promise(function(resolve,reject){_fs2.default.stat(file,function(err,stat){if(err)reject(err);else resolve(stat);});});}function getDeflatedPercent(oldSize,newSize){oldSize=parseInt(oldSize,10);newSize=parseInt(newSize,10);var deflated=100-newSize*100/oldSize;return deflated.toFixed(1)+'%';}